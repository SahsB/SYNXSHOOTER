<!DOCTYPE html>
<html>
<head> 
	<meta charset="UTF-8" />
    <title>Sync</title>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.4.8/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var socket = io();

function preload() {
    game.load.image('sky', '/assets/sky.png');
    game.load.image('bullet', '/assets/bullet.png');
	game.load.image('player', '/assets/THSR.png');
	game.load.image('enemy1', '/assets/EMU800.png');
	game.load.image('enemy_bullet', '/assets/bullet2.png');
    //game.load.spritesheet('dude', '/assets/dude.png', 32, 48);
}

var player;
var bullets;
var enemys;
var enemyBullets;

var score = 0;
var scoreText;

var fireRate = 100;
var nextFire = 0;

//var enemyFireRate = 500;
//var enemyNextFire = 0;

//var enemyRate = 1000;
var nextEnemy = 0;

function create() {
	setupBackground();
	setupPlayer();
	setupBullets();
	setupEnemys();
	setupEnemyBullets();
	
	scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '20px', fill: '#000' });
}

var newX = 0;
var newY = 0;

function update() {
    socket.on('setX', function(data) {
		newX = parseFloat(data);
    });
	socket.on('setY', function(data) {
		newY = parseFloat(data);
    });
	socket.on('shoot', function(data) {
		fire();
    });
	
    player.body.velocity.x = 10*(-newY);
	player.body.velocity.y = 10*(-newX);
	
	spawn_enemy();
	enemy_fire();
	
	game.physics.arcade.overlap(bullets, enemys, enemyHit, null, this);
	game.physics.arcade.overlap(player, enemys, playerHit, null, this);
	game.physics.arcade.overlap(player, enemyBullets, playerHit, null, this);
}

function fire() {
	if (player.alive && game.time.now > nextFire && bullets.countDead() > 0){
		nextFire = game.time.now + fireRate;
		var bullet = bullets.getFirstDead();
		bullet.reset(player.x, player.y - 10);
		bullet.body.velocity.y = -400;
	}
}

function spawn_enemy() {
	if (game.time.now > nextEnemy && enemys.countDead() > 0) {
        nextEnemy = game.time.now + game.rnd.integerInRange(1500, 3000);
        var enemy = enemys.getFirstExists(false);
        // spawn at a random location top of the screen
        enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0);
        // also randomize the speed
        enemy.body.velocity.y = game.rnd.integerInRange(30, 60);
		
		enemy.enemyNextFire = 0;
    }
}

function enemy_fire() {
	enemys.forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets.countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(1000, 5000);
			var enemy_bullet = enemyBullets.getFirstDead();
			enemy_bullet.reset(enemy.x+13, enemy.y + 32);
			enemy_bullet.body.velocity.y = 400;
		}
	}, this);
}

function enemyHit(bullet, enemy) {
	bullet.kill();
	enemy.kill();
	score += 10;
    scoreText.text = 'Score: ' + score;
}

function playerHit(player, enemy) {
	player.kill();
	enemy.kill();
	//Temporary Gameover message, will be overlapped if bullet hit enemy after death.
    scoreText.text = 'Score: ' + score + '\nGameover';
}

function setupBackground(){
	game.physics.startSystem(Phaser.Physics.ARCADE);
	game.add.sprite(0, 0, 'sky');
}

function setupPlayer(){
	player = game.add.sprite(game.width / 2, game.height - 50, 'player');
	game.physics.arcade.enable(player);
	player.body.collideWorldBounds = true;
	//game.player.body.setSize(20, 20, 0, -5);
}

function setupBullets(){
	bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;

    bullets.createMultiple(50, 'bullet');
    bullets.setAll('checkWorldBounds', true);
    bullets.setAll('outOfBoundsKill', true);
}

function setupEnemys(){
	enemys = game.add.group();
    enemys.enableBody = true;
    enemys.physicsBodyType = Phaser.Physics.ARCADE;

    enemys.createMultiple(50, 'enemy1');
    enemys.setAll('checkWorldBounds', true);
    enemys.setAll('outOfBoundsKill', true);
}

function setupEnemyBullets(){
	enemyBullets = game.add.group();
    enemyBullets.enableBody = true;
    enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;

    enemyBullets.createMultiple(100, 'enemy_bullet');
    enemyBullets.setAll('checkWorldBounds', true);
    enemyBullets.setAll('outOfBoundsKill', true);
}

</script>

</body>
</html>