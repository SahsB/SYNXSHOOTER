<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
    <title>Sync</title>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.4.8/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var socket = io();

function preload() {
    game.load.image('sky', '/assets/seatiles.jpg');
    game.load.image('bullet', '/assets/shump_assets/player_bullet_2.png');
		game.load.image('player', '/assets/THSR.png');
		game.load.image('enemy1', '/assets/EMU800.png');
		game.load.image('enemy2', '/assets/EMU700.png');
		game.load.image('enemy3', '/assets/shump_assets/mob_flagship_1.png');
		game.load.image('enemy_bullet1', '/assets/bullet.png');
		game.load.image('enemy_bullet2', '/assets/shump_assets/mob_bullet_2.png');
		game.load.image('square', '/assets/tile_question_box.png');
		game.load.spritesheet('bonus_cube', 'assets/shump_assets/cubes.png', 24, 24);
		game.load.spritesheet('explosion', 'assets/shump_assets/explosion_1.png', 32, 32);
    //game.load.spritesheet('dude', '/assets/dude.png', 32, 48);
		//game.load.spritesheet('player_bullet', '/assets/shump_assets/player_bullets.png');
}

var player, bullets;
var enemys = new Array(), enemyBullets = new Array();
var enemy_num = [20, 10, 2];
var lives;
const MAX_LIFE = 3;
var weaponLevel = 0;
const MAX_WEAPON_LEVEL = 4;
var boxes;
var explosionPool;

var score = 0;
var scoreText;

var gameOverText;

var fireRate = 100;
var nextFire = 0;

//var enemyFireRate = 500;
//var enemyNextFire = 0;

//var enemyRate = 1000;
var nextEnemy = 0, nextEnemy2 = 0, nextEnemy3 = 100000;
var nextBox = 0;

function create() {
	setupBackground();
	setupPlayer();
	setupBullets();
	setupEnemys();
	setupEnemyBullets();
	setupPlayerLives();
	setupBoxes();
	setupExplosions();

	scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '20px', fill: '#000' });

}

var newX = 0;
var newY = 0;

function update() {
    socket.on('setX', function(data) {
		newX = parseFloat(data);
    });
	socket.on('setY', function(data) {
		newY = parseFloat(data);
    });
	socket.on('shoot', function(data) {
		fire();
		if( !player.alive )	{
			setupPlayer();
			setupBullets();
			setupPlayerLives();
			gameOverText.kill();
		}
  });

    player.body.velocity.x = 10*(-newY);
	player.body.velocity.y = 10*(-newX);

	spawn_enemy();
	enemy_fire();

	add_boxes();

	for (var i=0;i<3;i++){
		game.physics.arcade.overlap(bullets, enemys[i], enemyHit, null, this);
		game.physics.arcade.overlap(player, enemys[i], playerHit, null, this);
	}
	for( var i = 0 ; i < 2;  i ++ )	{
		game.physics.arcade.overlap(player, enemyBullets[i], playerHitbullet, null, this);
	}

	game.physics.arcade.overlap(player, boxes, PlayerVsBox, null, this);
}

function fire() {
	if (player.alive && game.time.now > nextFire && bullets.countDead() > 0){
		nextFire = game.time.now + fireRate;
		var bullet = bullets.getFirstDead();
		bullet.reset(player.x , player.y - 10);
		bullet.body.velocity.y = -400;
		if (this.bullets.countDead() < weaponLevel * 2) {
			return;
		}
		for (var i = 1; i <= weaponLevel; i++) {
			bullet = bullets.getFirstExists(false);
			// spawn left bullet slightly left off center
			bullet.reset(player.x - i * 6, player.y - 10);
			// the left bullets spread from -95 degrees to -135 degrees
			game.physics.arcade.velocityFromAngle(
				-95 - i * 10, 400, bullet.body.velocity
			);

			bullet = bullets.getFirstExists(false);
			// spawn right bullet slightly right off center
			bullet.reset(player.x + i * 6, player.y - 10);
			// the right bullets spread from -85 degrees to -45
			game.physics.arcade.velocityFromAngle(
				-85 + i * 10, 400, bullet.body.velocity
			);
		}
	}
}

function add_boxes()	{
	if( game.time.now > nextBox && boxes.countDead() > 0 )	{
		nextBox = game.time.now + game.rnd.integerInRange(10000, 30000);
		var box = boxes.getFirstExists(false);
		// spawn at a random location top of the screen
		box.reset(game.rnd.integerInRange(20, game.width - 20), 0);
		box.scale.setTo(1.5, 1.5);
		box.play('box', 15, true, false);
		// also randomize the speed
		game.physics.arcade.velocityFromAngle(
			game.rnd.integerInRange(180, 360), 50, box.body.velocity
		);
	}
}

function spawn_enemy() {
		if (game.time.now > nextEnemy && enemys[0].countDead() > 0) {
        nextEnemy = game.time.now + game.rnd.integerInRange(1000, 3000);
        var enemy = enemys[0].getFirstExists(false);
        // spawn at a random location top of the screen
        enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0);
        // also randomize the speed
        enemy.body.velocity.y = game.rnd.integerInRange(30, 60);

				enemy.enemyNextFire = 0;
    }
		if (game.time.now > nextEnemy2 && enemys[1].countDead() > 0) {
        nextEnemy2 = game.time.now + game.rnd.integerInRange(2000, 4000);
        var enemy = enemys[1].getFirstExists(false);
        // spawn at a random location top of the screen
        enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0);
				var target = game.rnd.integerInRange(20, game.width - 20);
				enemy.rotation = game.physics.arcade.moveToXY(
				  enemy, target, game.height,
				  game.rnd.integerInRange(40, 80)
				) - Math.PI / 2;

				enemy.enemyNextFire = 0;
    }

		if (game.time.now > nextEnemy3 && enemys[2].countDead() > 0) {
			nextEnemy3 = game.time.now + game.rnd.integerInRange(100000, 300000);
			var enemy = enemys[2].getFirstExists(false);
			// spawn at a random location top of the screen
			enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0);
			// also randomize the speed
			enemy.body.velocity.y = game.rnd.integerInRange(10, 20);

			enemy.enemyNextFire = 0;
	  }
}

function enemy_fire() {
	enemys[0].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[0].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(1000, 3000);
			var enemy_bullet = enemyBullets[0].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + enemy.height/2);
			enemy_bullet.body.velocity.y=400;
		}
	}, this);

	enemys[1].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[0].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(2000, 5000);
			var enemy_bullet = enemyBullets[0].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + enemy.height/2);
			game.physics.arcade.moveToObject(enemy_bullet, player, 400);
		}
	}, this);

	enemys[2].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[1].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(5000, 10000);
			var enemy_bullet = enemyBullets[1].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + enemy.height/2);
			game.physics.arcade.moveToObject(enemy_bullet, player, 300);
		}
	}, this);
}

function enemyHit(bullet, enemy) {
	bullet.kill();
	explode(enemy);
	enemy.kill();
	score += 10;
  scoreText.text = 'Score: ' + score;
}

function playerHit(player, enemy) {
	explode(enemy);
	enemy.kill();
	player.kill();

	var life = lives.getFirstAlive();
    if (life !== null) {
			life.kill();
			explode(player);
			socket.emit('vibrate', 'hit');
			// re alive player
			setupPlayer();
    } else {
			//player.kill();
			explode(player);
			socket.emit('vibrate', 'die');
			gameOver();
    }
}

function playerHitbullet(player, bullet) {
	bullet.kill();
	player.kill();

	var life = lives.getFirstAlive();
    if (life !== null) {
			life.kill();
			explode(player);
			socket.emit('vibrate', 'hit');
			// re alive player
			setupPlayer();
    } else {
			//player.kill();
			explode(player);
			socket.emit('vibrate', 'die');
			gameOver();
    }
}

function PlayerVsBox(player, box)	{
	box.kill();
	score += 50;
  scoreText.text = 'Score: ' + score;
	if( weaponLevel < MAX_WEAPON_LEVEL )
		weaponLevel ++;
}

function explode(sprite) {
	if (explosionPool.countDead() === 0) {
		return;
	}
	var explosion = explosionPool.getFirstExists(false);
	explosion.reset(sprite.x, sprite.y);
	explosion.play('boom', 15, false, true);
	// add the original sprite's velocity to the explosion
	explosion.body.velocity.x = sprite.body.velocity.x;
	explosion.body.velocity.y = sprite.body.velocity.y;
}

function gameOver(){
	gameOverText = game.add.text(game.width/2, game.height / 2, 'Game Over!', { font: '32px sans-serif', fill: '#fff'});
	gameOverText.anchor.setTo(0.5, 0.5);
}

function setupBackground(){
	game.physics.startSystem(Phaser.Physics.ARCADE);
	// Stretch to fill
  //game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;

	var sky = game.add.sprite(0, 0, 'sky');
	sky.scale.setTo(window.innerWidth/sky.width, window.innerHeight/sky.height);
}

function setupPlayer(){
	player = game.add.sprite(game.width / 2, game.height - 50, 'player');
	game.physics.arcade.enable(player);
	player.body.collideWorldBounds = true;
	//game.player.body.setSize(20, 20, 0, -5);
	player.anchor.x = 0.5;
	player.anchor.y = 0.5;
	player.scale.setTo(1.5, 1.5);
}

function setupBullets(){
		bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;

    bullets.createMultiple(1000, 'bullet');
    bullets.setAll('checkWorldBounds', true);
    bullets.setAll('outOfBoundsKill', true);
}

function setupEnemys(){
	for(var i=0;i<3;i++){
		enemys[i] = game.add.group();
		enemys[i].enableBody = true;
		enemys[i].physicsBodyType = Phaser.Physics.ARCADE;

		enemys[i].createMultiple(enemy_num[i], 'enemy'+(i+1));
		enemys[i].setAll('checkWorldBounds', true);
		enemys[i].setAll('outOfBoundsKill', true);
		enemys[i].setAll('anchor.x', 0.5);
		enemys[i].setAll('anchor.y', 0.5);
		enemys[i].setAll('scale.x', 1.5);
		enemys[i].setAll('scale.y', 1.5);
	}
}

function setupEnemyBullets(){
	for( var i = 0 ; i < 2 ; i ++ )	{
		enemyBullets[i] = game.add.group();
		enemyBullets[i].enableBody = true;
		enemyBullets[i].physicsBodyType = Phaser.Physics.ARCADE;

		enemyBullets[i].createMultiple(100, 'enemy_bullet' + (i+1) );
		enemyBullets[i].setAll('checkWorldBounds', true);
		enemyBullets[i].setAll('outOfBoundsKill', true);
	}
}

function setupPlayerLives(){
	lives = game.add.group();
	var firstLifeIconX = this.game.width - 10 - (MAX_LIFE * 30);
	for (var i = 0; i < MAX_LIFE; i++) {
		var lifeIcon = this.lives.create(firstLifeIconX + (30 * i), 30, 'player');
		lifeIcon.scale.setTo(0.8, 0.8);
		lifeIcon.anchor.setTo(0.5, 0.5);
	}
}

function setupBoxes() {
	boxes = game.add.group();
	boxes.enableBody = true;
	boxes.physicsBodyType = Phaser.Physics.ARCADE;

	boxes.createMultiple(4, 'bonus_cube');
	boxes.setAll('body.collideWorldBounds', true);
	boxes.setAll('outOfBoundsKill', true);
	boxes.setAll('body.bounce.x', 1);
	boxes.setAll('body.bounce.y', 1);
	boxes.forEach(function(box)	{
		box.animations.add('box');
	});
}

function setupExplosions() {
	explosionPool = game.add.group();
	explosionPool.enableBody = true;
	explosionPool.physicsBodyType = Phaser.Physics.ARCADE;
	explosionPool.createMultiple(100, 'explosion');
	explosionPool.setAll('anchor.x', 0.5);
	explosionPool.setAll('anchor.y', 0.5);
	explosionPool.setAll('scale.x', 1.5);
	explosionPool.setAll('scale.y', 1.5);
	explosionPool.forEach(function (explosion) {
		explosion.animations.add('boom');
	});
}

</script>

</body>
</html>
