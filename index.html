<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
    <title>Sync</title>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/phaser/2.4.8/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">

var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var socket = io();

function preload() {
	game.load.image('gamestartMenu', '/assets/gamestart.png');
	game.load.image('sky', '/assets/seatiles.png');
	game.load.image('bullet', '/assets/shump_assets/player_bullet_2.png');
	game.load.image('ray', '/assets/ray.png');
	game.load.image('player', '/assets/THSR.png');
	game.load.image('enemy1', '/assets/EMU800.png');
	game.load.image('enemy2', '/assets/EMU700.png');
	game.load.image('enemy3', '/assets/shump_assets/mob_flagship_1.png');
	game.load.image('enemy_bullet1', '/assets/bullet.png');
	game.load.image('enemy_bullet2', '/assets/shump_assets/mob_bullet_2.png');
	game.load.image('square', '/assets/tile_question_box.png');
	game.load.image('ultsign', '/assets/50ult.png');
	game.load.image('ultsign_g', '/assets/50ult_gray.png');
	game.load.spritesheet('bonus_cube', 'assets/shump_assets/cubes.png', 24, 24);
	game.load.spritesheet('enemy0', '/assets/shump_assets/mob_turret_1.png', 24, 24);
	game.load.spritesheet('explosion', 'assets/shump_assets/explosion_1.png', 32, 32);
	game.load.spritesheet('shield', 'assets/magic.png', 192, 192);
	game.load.spritesheet('lightning', 'assets/lightning.png', 55, 237);
	game.load.spritesheet('rocket', 'assets/arrows.png', 48, 48);
	game.load.spritesheet('fireball', '/assets/fireball.png', 32, 30);
}

//Weapon Ult
const BULLET = 0, RAY = 1, LIGHTNING = 2, MAX_WEAPON_LEVEL = 4;
const EMPTY = 0, FILLED = 1; //ULT state
var bullets, rays, lightnings;
var weaponLevel = 0;
var weaponMode = game.rnd.integerInRange(BULLET,LIGHTNING);
var weapon_num = [500, 20, 10];
var fireRate, rayfireRate, lightningfireRate;
var nextFire = 0;
var player_bullet_velocity = 750;
var ultText, ultsign, ultsign_g;
var ult = EMPTY;
var ultstate = ['restore','ready'];

// Difficulty Score Menu Gameover Gamestate Background
const INGAME = 1, STARTGAME = 0, ENDGAME = -1;
const CHANGING = 1, NOCHANGE = 0;
var DIFFICULTY = 1;
var DIFFICULTY_CHANGE=NOCHANGE;
var difficultyText;
var levelup_loop;
var score = 0;
var scoreText;
var gamestartMenu;
var gameOverText;
var state = 0;
var background;
var background_movement = 1;

//Player
const MAX_LIFE = 3;
var player, lives;
var playerSpawnUndeadTime = 3000; // in milliseconds
var playerSpawnUndead = false;	//whether player is undead
var tweenPlayer; //the tween effects of player
var shield;
var newX = 0;
var newY = 0;
var rocketPool, rocket_velocity = 800;

// The following 2 variables are the properties of SuperPlayer. (see function superPlayer() below)
var playerSuperTime = 10000;
var playerSuper = false;

//ENEMY
const ENEMY_0_HEALTH = 5, ENEMY_1_HEALTH = 1, ENEMY_2_HEALTH = 3, ENEMY_3_HEALTH = 500;
var enemys = new Array();
var enemy_num = [4, 20, 10, 2];
var enemyBullets = new Array();
var enemyBullet_num = [200, 200];
var enemy_bullet_velocity = 350, enemy_bullet_velocity2 = 250, enemy_bullet_velocity3 = 200;
var nextEnemy0 = 0, nextEnemy = 0, nextEnemy2 = 0, nextEnemy3 = 10000;

//Others
const yellow = 0, orange = 1, green = 2, chocolate = 3, blue = 4, dark_blue = 5, gray = 6, colorful = 7;
var boxes;
var nextBox = 0;
var explosionPool;
var fireballs, fireball1, fireball2, fireball3;
var fireballEvent1, fireballEvent2, fireballEvent3;
var fireballStartTime;
var ballsSurrounded=false;

function create() {
	setupBackground();
	setupBullets();
	setupRays();
	setupLightnings();
	setupFireRate();
	setupFireBalls();
	setupEnemys();
	setupEnemyBullets();
	setupPlayer(false);
	setupPlayerLives();
	setupBoxes();
	setupExplosions();
	setupMenu();
	setupULT();
	setupRocket();
	scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '20px', fill: '#000' });
	ultText = game.add.text(65, 50, 'ULT state: restore', { fontSize: '20px', fill: '#000' });
}

function update() {
	background.tilePosition.y += background_movement;
	enemys[0].forEachAlive(function(enemy)	{
		enemy.position.y += background_movement;
	}, this);

	listenSocket();

	updateText();

	if(state===INGAME){

		player.body.velocity.x = 10*(-newY);
		player.body.velocity.y = 10*(-newX);

		player.shield.position.x = player.position.x;
		player.shield.position.y = player.position.y + player.height/2;;

		if(DIFFICULTY_CHANGE===NOCHANGE){
			spawn_enemy();
			enemy_fire();
			add_boxes();
		}

		//player self group related
		createRocket();
		rotateRocket();

		for( var i = 0 ; i < 4 ; i ++ ) {
			if(weaponMode===BULLET) game.physics.arcade.overlap(bullets, enemys[i], enemyHit, null, this);
			else if(weaponMode===RAY) game.physics.arcade.overlap(rays, enemys[i], rayenemyHit, null, this);
			else if(weaponMode===LIGHTNING){
				game.physics.arcade.overlap(lightnings, enemys[i], lightningenemyHit, null, this);
				for(var j = 0 ; j < 2;  j ++ )	{
					game.physics.arcade.overlap(lightnings, enemyBullets[i], lightningBulletHit, null, this);
				}
			}
			if(ballsSurrounded === true){
				var par = (game.time.now-fireballStartTime)/1000*Math.PI;
				//console.log(par);
				fireball1.position.x = player.position.x+100*Math.sin(par);
				fireball1.position.y = player.position.y+100*Math.cos(par);
				fireball2.position.x = player.position.x+100*Math.sin(par+2/3*Math.PI);
				fireball2.position.y = player.position.y+100*Math.cos(par+2/3*Math.PI);
				fireball3.position.x = player.position.x+100*Math.sin(par+4/3*Math.PI);
				fireball3.position.y = player.position.y+100*Math.cos(par+4/3*Math.PI);
				game.physics.arcade.overlap(fireballs, enemys[i], fireballenemyHit, null, this);
			}
			if( i != 0 )	// player(on sky) cannot touch enemys[0](on land)
				game.physics.arcade.overlap(player, enemys[i], playerHit, null, this);

			//rocket vs enemy
			game.physics.arcade.overlap(rocketPool, enemys[i], enemyHit, null, this);
		}
		for( var i = 0 ; i < 2;  i ++ )	{
			game.physics.arcade.overlap(player, enemyBullets[i], playerHitByBullet, null, this);
		}

		game.physics.arcade.overlap(player, boxes, PlayerVsBox, null, this);
	}
}

function listenSocket(){
	socket.on('setX', function(data) {
		newX = parseFloat(data);
	});
	socket.on('setY', function(data) {
		newY = parseFloat(data);
	});
	socket.on('ultra', function(data) {
		if(player.alive)
			launchult();
	});
	socket.on('start', function(data) {
		state=STARTGAME;
		if( !player.alive )	{
			setupPlayer(false);
			weaponLevel=0;
			score=0;
			resetPlayerLives();
			gameOverText.kill();
		}
		resetMenu();
	});
	socket.on('shoot', function(data) {
		if(state===STARTGAME){
			game.time.events.add(Phaser.Timer.SECOND * 10, fillult, this);
			levelup_loop=game.time.events.loop(Phaser.Timer.SECOND * 25, difficultyUP, this);
			state=INGAME;
			setupFireRate();
			gamestartMenu.kill();
			setPlayerSpawnTimeUndead(); // game start
		} else{
			fire();
		}
	});
	socket.on('switch_weapon', function(msg){
		 weaponMode = msg;
	});
}

function updateText(){
	scoreText.text = 'Score: ' + score;
	ultText.text = 'ULT state: ' + ultstate[ult];
}

function difficultyUP(){
	DIFFICULTY++;
	DIFFICULTY_CHANGE=CHANGING;
	enemy_bullet_velocity+=50;
	enemy_bullet_velocity2+=25;
	enemy_bullet_velocity3+=20;
	difficultyText = game.add.text(game.width/2, game.height/2, 'Difficulty: '+DIFFICULTY, { fontSize: '20px', fill: '#000' });
	difficultyText.anchor.setTo(0.5, 0.5);
	game.time.events.add(Phaser.Timer.SECOND * 5, difficultyTextDel, this);
}

function difficultyTextDel(){
	DIFFICULTY_CHANGE=NOCHANGE;
	difficultyText.kill();
}

function fire() {
	if(weaponMode===BULLET){
		if (player.alive && game.time.now > nextFire && bullets.countDead() > 0){
			if (this.bullets.countDead() < weaponLevel * 2) {
				return;
			}
			nextFire = game.time.now + fireRate;
			var bullet = bullets.getFirstDead();
			bullet.reset(player.x , player.y - 10);
			bullet.body.velocity.y = -player_bullet_velocity;

			for (var i = 1; i <= weaponLevel; i++) {
				bullet = bullets.getFirstExists(false);
				bullet.reset(player.x - i * 6, player.y - 10); // spawn left bullet slightly left off center
				game.physics.arcade.velocityFromAngle(
					-95 - i * 10, player_bullet_velocity, bullet.body.velocity
				); // the left bullets spread from -95 degrees to -135 degrees

				bullet = bullets.getFirstExists(false);
				bullet.reset(player.x + i * 6, player.y - 10); // spawn right bullet slightly right off center
				game.physics.arcade.velocityFromAngle(
					-85 + i * 10, player_bullet_velocity, bullet.body.velocity
				); // the right bullets spread from -85 degrees to -45
			}
		}
	}
	else if(weaponMode===RAY){
		if (player.alive && game.time.now > nextFire && rays.countDead() > 0){
			nextFire = game.time.now + rayfireRate;
			var ray = rays.getFirstDead();
			ray.reset(player.x , player.y - 10);
			ray.body.velocity.y = -player_bullet_velocity*5;
			ray.scale.setTo(1+0.5*weaponLevel,1);
		}
	}
	else if(weaponMode===LIGHTNING){
		if (player.alive && game.time.now > nextFire && lightnings.countDead() > 0){
			nextFire = game.time.now + lightningfireRate;
			var lightning = lightnings.getFirstDead();
			lightning.reset(player.x , 0);
			lightning.scale.setTo(1, 3);
			lightning.animations.add('lightning', [0,1,2,3,4,5], 6, true); //single-color box
			lightning.play('lightning', 15, true, false);
			game.time.events.add(Phaser.Timer.SECOND * (6+weaponLevel), fadeLightning, this, lightning);
		}
	}
}

function fillult(){
	ult=FILLED;
	ultsign = game.add.sprite(16, 36, 'ultsign');
	ultText.fill='#F00';
	socket.emit('ULT', 'filled');
}

function launchult(){
	if(ult===FILLED){
		ult=EMPTY;
		ultText.fill='#000';
		ultsign.kill();
		enemys[0].forEachAlive(function (enemy) {
			explode(enemy);
			enemy.kill();
			score+=10;
		}, this);
		enemys[1].forEachAlive(function (enemy) {
			explode(enemy);
			enemy.kill();
			score+=10;
		}, this);
		enemys[2].forEachAlive(function (enemy) {
			explode(enemy);
			enemy.kill();
			score+=10;
		}, this);
		enemys[3].forEachAlive(function (enemy) {
			explode(enemy);
			enemy.damage(100);
			if(!enemy.alive) score+=10;
		}, this);
		enemyBullets[0].forEachAlive(function (bullet) {
			explode(bullet);
			bullet.kill();
		}, this);
		enemyBullets[1].forEachAlive(function (bullet) {
			explode(bullet);
			bullet.kill();
		}, this);
		game.time.events.add(Phaser.Timer.SECOND * 10, fillult, this);
	}
}

function add_boxes()	{
	if( game.time.now > nextBox && boxes.countDead() > 0 )	{
		nextBox = game.time.now + game.rnd.integerInRange(10000, 30000);
		var box = boxes.getFirstExists(false);
		box.reset(game.rnd.integerInRange(20, game.width - 20), 0); // spawn at a random location top of the screen
		box.scale.setTo(1.5, 1.5);
		var rnd = game.rnd.integerInRange(0, 7);
		if (rnd === 7)
			box.animations.add('box', [0,3,6,9,12,15,18,1,4,7,10,13,16,19,2,5,8,11,14,17,20], 21, true); //colorful box
		else
			box.animations.add('box', [rnd*3, rnd*3+1, rnd*3+2], 21, true); //single-color box
		box.play('box', 15, true, false);
		box.type = rnd;
		game.physics.arcade.velocityFromAngle(
			game.rnd.integerInRange(180, 360), 50, box.body.velocity
		); // also randomize the speed

		game.time.events.add(Phaser.Timer.SECOND * 120, fadeBox, this, box);
	}
}

function fadeBox(box) {
	box.kill();
}

function fadeLightning(lightning) {
	lightning.kill();
}

function fadeFireball(fireball)	{
	ballsSurrounded = false;
	fireball.kill();
}

function resetFireballs(){
	game.time.events.remove(fireballEvent1);
	game.time.events.remove(fireballEvent1);
	game.time.events.remove(fireballEvent1);
	fireball1.kill();
	fireball2.kill();
	fireball3.kill();
	ballsSurrounded = false;
}


function spawn_enemy() {
	if (game.time.now > nextEnemy0 && enemys[0].countDead() > 0) {
		nextEnemy0 = game.time.now + game.rnd.integerInRange(10000, 10000);
		var enemy = enemys[0].getFirstExists(false);
		// spawn at a random location top of the screen
		enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0, ENEMY_0_HEALTH);

		enemy.enemyNextFire = 0;

		// animationq
		enemy.animations.add('open', [0, 1, 2, 3, 4, 5, 6, 7, 8, 8, 8, 8, 8, 8], 20, false);
		enemy.animations.add('close', [8, ,8 ,8 ,8, 8, 8, 7, 6, 5, 4, 3, 2, 1, 0], 20, false);

		enemy.loop = game.time.events.loop(Phaser.Timer.SECOND * 10, enemy0_attack, this, enemy);
	}
	if (game.time.now > nextEnemy && enemys[1].countDead() > 0) {
		nextEnemy = game.time.now + game.rnd.integerInRange(1000, 3000);
		var enemy = enemys[1].getFirstExists(false);
		// spawn at a random location top of the screen
		enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0, ENEMY_1_HEALTH);
		// also randomize the speed
		enemy.body.velocity.y = game.rnd.integerInRange(30, 60);

		enemy.enemyNextFire = 0;
	}
	if (game.time.now > nextEnemy2 && enemys[2].countDead() > 0) {
		nextEnemy2 = game.time.now + game.rnd.integerInRange(2000, 4000);
		var enemy = enemys[2].getFirstExists(false);
		// spawn at a random location top of the screen
		enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0, ENEMY_2_HEALTH);
		var target = game.rnd.integerInRange(20, game.width - 20);
		enemy.rotation = game.physics.arcade.moveToXY(
			enemy, target, game.height,
			game.rnd.integerInRange(40, 80)
		) - Math.PI / 2;

		enemy.enemyNextFire = 0;
	}
	if (game.time.now > nextEnemy3 && enemys[3].countDead() > 0) {
		nextEnemy3 = game.time.now + game.rnd.integerInRange(60000, 120000);
		var enemy = enemys[3].getFirstExists(false);
		// spawn at a random location top of the screen
		enemy.reset(game.rnd.integerInRange(20, game.width - 20), 0, ENEMY_3_HEALTH);
		// also randomize the speed
		enemy.body.velocity.y = game.rnd.integerInRange(10, 20);

		enemy.enemyNextFire = 0;

		console.log("Ewidth = " + enemy.width + ", Eheight = " + enemy.height);
	}
}

function enemy0_attack(enemy)	{
	if ( enemyBullets[1].countDead() > 0 && enemy.alive ){
		enemy.play('open');
		for( var i = 0 ; i < 3 ; i ++ )	{
			//  left
			var enemy_bullet = enemyBullets[1].getFirstDead();
			enemy_bullet.reset(enemy.x - i*30, enemy.y );
			enemy_bullet.body.velocity.x = -200;
			// right
			enemy_bullet = enemyBullets[1].getFirstDead();
			enemy_bullet.reset(enemy.x + i*30, enemy.y );
			enemy_bullet.body.velocity.x = 200;
			// bottom
			enemy_bullet = enemyBullets[1].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + i*30);
			enemy_bullet.body.velocity.y = 200;
			// top
			enemy_bullet = enemyBullets[1].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y - i*30);
			enemy_bullet.body.velocity.y = -200;
		}
		enemy.play('close');
	}else if( !enemy.alive ){
		game.time.events.remove(enemy.loop);
	}
}

function enemy_fire() {
	enemys[1].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[0].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(1000, 3000);
			var enemy_bullet = enemyBullets[0].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + enemy.height/2);
			enemy_bullet.body.velocity.y = enemy_bullet_velocity;
		}
	}, this);

	enemys[2].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[0].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(2000, 5000);
			var enemy_bullet = enemyBullets[0].getFirstDead();
			enemy_bullet.reset(enemy.x, enemy.y + enemy.height/2);
			game.physics.arcade.moveToObject(enemy_bullet, player, enemy_bullet_velocity2);
		}
	}, this);

	enemys[3].forEachAlive(function (enemy) {
		if (game.time.now > enemy.enemyNextFire && enemyBullets[1].countDead() > 0){
			enemy.enemyNextFire = game.time.now + game.rnd.integerInRange(5000, 6000);
			for( var i = 0 ; i < 5 ; i ++ )	{
				var enemy_bullet = enemyBullets[1].getFirstDead();
				enemy_bullet.reset(enemy.x + 50, enemy.y + enemy.height/2 - i*30);
				game.physics.arcade.moveToObject(enemy_bullet, player, enemy_bullet_velocity3);
				enemy_bullet = enemyBullets[1].getFirstDead();
				enemy_bullet.reset(enemy.x - 50, enemy.y + enemy.height/2 - i*30);
				game.physics.arcade.moveToObject(enemy_bullet, player, enemy_bullet_velocity3);
			}
		}
	}, this);
}

function createRocket()	{
	if (game.time.now > player.nextRocket && rocketPool.countDead() > 0){
		player.nextRocket = game.time.now + 3000;
		for( var i = 0 ; i < 1 ; i ++ )	{
			var rocket = rocketPool.getFirstDead();
			rocket.reset(player.x + 50, player.y + player.height/2 + i*30);
			rocket.target = enemys[game.rnd.integerInRange(0, 3)].getFirstAlive();
			rocket.angle = 5 + i*20;
			game.physics.arcade.velocityFromAngle( -95 - i*20, rocket_velocity, rocket.body.velocity);

			rocket = rocketPool.getFirstDead();
			rocket.reset(player.x - 50, player.y + player.height/2 + i*30);
			rocket.target = enemys[game.rnd.integerInRange(0, 3)].getFirstAlive();
			rocket.angle = -5 + i*20;
			game.physics.arcade.velocityFromAngle( -85 + i*20, rocket_velocity, rocket.body.velocity);
		}
	}
}

function rotateRocket()	{
	rocketPool.forEachAlive(function(rocket)	{
		if( rocket.target != null && rocket.target.alive )	{
			var radians = game.physics.arcade.angleBetween(rocket, rocket.target);
			degrees = radians * (180/Math.PI);
			game.physics.arcade.velocityFromAngle(degrees, rocket_velocity, rocket.body.velocity);
			rocket.angle = degrees+90;
		}else {
			// velocity along original

		}
	}, this);
}

function enemyHit(bullet, enemy) {
	bullet.kill();
	enemy.damage(1);
	//if (enemy.alive) play hit animation(not available yet) else play explode animation
	explode(enemy);
	score += 10;
}

function rayenemyHit(bullet, enemy) {
	enemy.damage(1);
	//if (enemy.alive) play hit animation(not available yet) else play explode animation
	explode(enemy);
	score += 10;
}

function lightningenemyHit(lightning, enemy) {
	enemy.damage(1);
	//if (enemy.alive) play hit animation(not available yet) else play explode animation
	explode(enemy);
	score += 10;
}

function fireballenemyHit(fireball, enemy) {
	enemy.damage(1);
	//if (enemy.alive) play hit animation(not available yet) else play explode animation
	explode(enemy);
	score += 10;
}

function lightningBulletHit(lightning, bullet) {
	explode(bullet);
	bullet.kill();
	score += 5;
}

function playerHit(player, enemy) {
	if (playerSpawnUndead === true) {
		return;
	}
	else if (playerSuper === true) {
		explode(enemy);
		enemy.kill();
		score += 10;
		return;
	}
	explode(enemy);
	explode(player);
	enemy.kill();
	game.time.events.remove(player.shield.loop);

	var life = lives.getFirstAlive();
	if (life !== null) {
		life.kill();
		socket.emit('vibrate', 'hit');
		setPlayerSpawnTimeUndead();
		player.reset(game.width / 2, game.height - 50);
	} else {
		player.kill();
		player.shield.kill();
		if(ballsSurrounded === true)
			resetFireballs();
		socket.emit('vibrate', 'die');
		gameOver();
	}
}

function playerHitByBullet(player, bullet) {
	if (playerSpawnUndead === true) {
		return;
	}
	else if (playerSuper === true) {
		bullet.kill();
		return;
	}
	explode(player);
	bullet.kill();
	game.time.events.remove(player.shield.loop);

	var life = lives.getFirstAlive();
	if (life !== null) {
		life.kill();
		socket.emit('vibrate', 'hit');
		setPlayerSpawnTimeUndead();
		player.reset(game.width / 2, game.height - 50);
	} else {
		player.kill();
		player.shield.kill();
		if(ballsSurrounded === true)
			resetFireballs();
		socket.emit('vibrate', 'die');
		gameOver();
	}
}

function PlayerVsBox(player, box)	{
	switch(box.type)	{
		case yellow:
			FireBallSurround(player);
			weaponLevel--
			break;
		case orange:
			weaponLevel--;
			heal();
			break;
		case green:
			weaponLevel--;
			if(fireRate>100){
				fireRate-=25;
				rayfireRate-=100;
				lightningfireRate-=250;
			}
			break;
		case chocolate:
			break;
		case blue:
			break;
		case dark_blue:
			break;
		case gray:
			break;
		case colorful:
			superPlayer();
			break;
	}

	box.kill();
	score += 50;
	if( weaponLevel < MAX_WEAPON_LEVEL )
		weaponLevel ++;
}

function heal()	{
	var dead_lives = lives.countDead();
	if( dead_lives > 0 ) 	{
		var newlife = lives.getChildAt(dead_lives-1);
		newlife.reset(this.game.width - 10 - (MAX_LIFE * 30) + 30*(dead_lives-1) , 30);
	}
}

// When got a colorful box, the player can become undead and kill the enemies (except turrets) with bumping
function superPlayer(){
	var tint = player.tint;
	player.alpha = 1;
	tweenPlayer.stop();
	playerSuper = true;
	playerSpawnUndead = false;
	var startTime = Date.now();
	var tween1 = game.add.tween(player).to({ tint: 0xff00ff }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	var tween2 = game.add.tween(player).to({ tint: 0x00ffff }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	var tween3 = game.add.tween(player).to({ tint: 0x0000ff }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	var tween4 = game.add.tween(player).to({ tint: 0xff00ff }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	var tween5 = game.add.tween(player).to({ tint: 0xff0000 }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	var tween6 = game.add.tween(player).to({ tint: 0xffff00 }, 200, Phaser.Easing.Linear.None, false, 0, 1, false);
	tween1.chain(tween2);
	tween2.chain(tween3);
	tween3.chain(tween4);
	tween4.chain(tween5);
	tween5.chain(tween6);
	tween6.chain(tween1);
	tween1.start();
	game.time.events.add(playerSuperTime, function(){
		tween1.stop();
		tween2.stop();
		tween3.stop();
		tween4.stop();
		tween5.stop();
		tween6.stop();
		player.tint = tint;
		playerSuper = false;
	}, this);
}

function swap(){
	if(weaponMode===BULLET) weaponMode=LIGHTNING;
	else if(weaponMode===LIGHTNING) weaponMode=RAY;
	else weaponMode=BULLET;
}

function FireBallSurround(sprite){
	fireballStartTime = game.time.now;
	ballsSurrounded=true;
	if (fireballs.countDead() === 0) {
		game.time.events.remove(fireballEvent1);
		game.time.events.remove(fireballEvent2);
		game.time.events.remove(fireballEvent3);
		fireballEvent1 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball1);
		fireballEvent2 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball2);
		fireballEvent3 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball3);
		return;
	}
	fireball1 = fireballs.getFirstDead();
	fireball1.reset(sprite.x+86.6, sprite.y+50);
	fireball1.animations.add('flame', [0,1,2], 3, true);
	fireball1.play('flame', 15, true, false);
	fireballEvent1 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball1);

	fireball2 = fireballs.getFirstDead();
	fireball2.reset(sprite.x-86.6, sprite.y-50);
	fireball2.animations.add('flame', [0,1,2], 3, true);
	fireball2.play('flame', 15, true, false);
	fireballEvent2 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball2);

	fireball3 = fireballs.getFirstDead();
	fireball3.reset(sprite.x, sprite.y-100);
	fireball3.animations.add('flame', [0,1,2], 3, true);
	fireball3.play('flame', 15, true, false);
	fireballEvent3 = game.time.events.add(Phaser.Timer.SECOND * 15, fadeFireball, this, fireball3);
}

function explode(sprite) {
	if (explosionPool.countDead() === 0) {
		return;
	}
	var explosion = explosionPool.getFirstExists(false);
	explosion.reset(sprite.x, sprite.y);
	explosion.play('boom', 15, false, true);
	explosion.body.velocity.x = sprite.body.velocity.x;
	explosion.body.velocity.y = sprite.body.velocity.y;
}

function gameOver(){
	state=ENDGAME;
	DIFFICULTY=1;
	game.time.events.remove(levelup_loop);
	gameOverText = game.add.text(game.width/2, game.height / 2, 'Game Over!', { font: '32px sans-serif', fill: '#fff'});
	gameOverText.anchor.setTo(0.5, 0.5);
}

function setupBackground(){
	game.physics.startSystem(Phaser.Physics.ARCADE);

	// Stretch to fill
	//game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;
	background = game.add.tileSprite(0, 0, window.innerWidth, window.innerHeight, 'sky');
	background.tileScale.x = window.innerWidth/background.width;
	background.tileScale.y = window.innerHeight/background.height;
}

// Parameter: isSetSpawnTimeUndead (default = true): The player will be undead after spawn time for "playerSpawnUndeadTime" milliseconds if this is true
function setupPlayer(isSetSpawnTimeUndead){

	isSetSpawnTimeUndead = typeof isSetSpawnTimeUndead !== 'undefined' ? isSetSpawnTimeUndead : true;

	player = game.add.sprite(game.width / 2, game.height - 50, 'player');
	game.physics.arcade.enable(player);
	player.body.collideWorldBounds = true;
	player.anchor.x = 0.5;
	player.anchor.y = 0.5;

	player.scale.setTo(1.5, 1.5);

	// shield
	player.shield = game.add.sprite(player.x, player.y, 'shield');
	game.physics.arcade.enable(player.shield);
	player.shield.anchor.x = 0.5;
	player.shield.anchor.y = 0.5;
	player.shield.animations.add('effect', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19], 20, true);
	player.shield.animations.play('effect');
	player.shield.loop = game.time.events.loop(Phaser.Timer.SECOND * 3, function()	{
		player.shield.animations.play('effect');
	}, this);

	// Rocket related
	player.nextRocket = 0;

	//player.addChild(shield);

	if (isSetSpawnTimeUndead === true)
		setPlayerSpawnTimeUndead();
}

function setPlayerSpawnTimeUndead(){
	player.alpha = 1;
	playerSpawnUndead = true;
	tweenPlayer = game.add.tween(player).to( { alpha: 0.5 }, 200, Phaser.Easing.Linear.None, true, 0, playerSpawnUndeadTime / (200 * 2), true);
	game.time.events.add(playerSpawnUndeadTime, function(){
		player.alpha = 1;
		tweenPlayer.stop();
		playerSpawnUndead = false;
	}, this);
}

function setupBullets(){
	bullets = game.add.group();
	bullets.enableBody = true;
	bullets.physicsBodyType = Phaser.Physics.ARCADE;

	bullets.createMultiple(weapon_num[BULLET], 'bullet');
	bullets.setAll('checkWorldBounds', true);
	bullets.setAll('outOfBoundsKill', true);
}

function setupRays(){
	rays = game.add.group();
	rays.enableBody = true;
	rays.physicsBodyType = Phaser.Physics.ARCADE;

	rays.createMultiple(weapon_num[RAY], 'ray');
	rays.setAll('checkWorldBounds', true);
	rays.setAll('outOfBoundsKill', true);
	rays.setAll('anchor.x', 0.5);
	rays.setAll('anchor.y', 0.8);
}

function setupLightnings(){
	lightnings = game.add.group();
	lightnings.enableBody = true;
	lightnings.physicsBodyType = Phaser.Physics.ARCADE;
	lightnings.createMultiple(weapon_num[LIGHTNING], 'lightning');
	lightnings.setAll('anchor.x', 0.5);
}

function setupFireRate(){
	fireRate = 200;
	rayfireRate=500;
	lightningfireRate=2000;
}

function setupFireBalls(){
	fireballs = game.add.group();
	fireballs.enableBody = true;
	fireballs.physicsBodyType = Phaser.Physics.ARCADE;
	fireballs.createMultiple(3, 'fireball');
	fireballs.setAll('anchor.x', 0.5);
	fireballs.setAll('anchor.y', 0.5);
	fireballs.setAll('scale.x', 0.8);
	fireballs.setAll('scale.y', 0.8);
}

function setupEnemys(){
	for(var i = 0 ; i < 4 ; i ++ ){
		enemys[i] = game.add.group();
		enemys[i].enableBody = true;
		enemys[i].physicsBodyType = Phaser.Physics.ARCADE;

		enemys[i].createMultiple(enemy_num[i], 'enemy'+i);
		enemys[i].setAll('checkWorldBounds', true);
		enemys[i].setAll('outOfBoundsKill', true);
		enemys[i].setAll('anchor.x', 0.5);
		enemys[i].setAll('anchor.y', 0.5);

		enemys[i].setAll('scale.x', (i == 3) ? 3 : 1.5);
		enemys[i].setAll('scale.y', (i == 3) ? 3 : 1.5);

		enemys[i].forEach(function(enemy)	{
			enemy.body.width *= enemy.scale.x;
			enemy.body.height *= enemy.scale.y;
		});
	}
}

function setupEnemyBullets(){
	for( var i = 0 ; i < 2 ; i ++ )	{
		enemyBullets[i] = game.add.group();
		enemyBullets[i].enableBody = true;
		enemyBullets[i].physicsBodyType = Phaser.Physics.ARCADE;

		enemyBullets[i].createMultiple(enemyBullet_num[i], 'enemy_bullet' + (i+1) );
		enemyBullets[i].setAll('checkWorldBounds', true);
		enemyBullets[i].setAll('outOfBoundsKill', true);
		enemyBullets[i].setAll('scale.x', 1.5);
		enemyBullets[i].setAll('scale.y', 1.5);
	}
}

function setupPlayerLives(){
	lives = game.add.group();
	var firstLifeIconX = this.game.width - 10 - (MAX_LIFE * 30);
	for (var i = 0; i < MAX_LIFE; i++) {
		var lifeIcon = this.lives.create(firstLifeIconX + (30 * i), 30, 'player');
		lifeIcon.scale.setTo(0.8, 0.8);
		lifeIcon.anchor.setTo(0.5, 0.5);
	}
}

function resetPlayerLives(){
	var firstLifeIconX = this.game.width - 10 - (MAX_LIFE * 30);
	for (var i = 0; i < MAX_LIFE; i++) {
		var lifeIcon = this.lives.create(firstLifeIconX + (30 * i), 30, 'player');
		lifeIcon.scale.setTo(0.8, 0.8);
		lifeIcon.anchor.setTo(0.5, 0.5);
	}
}

function setupBoxes() {
	boxes = game.add.group();
	boxes.enableBody = true;
	boxes.physicsBodyType = Phaser.Physics.ARCADE;

	boxes.createMultiple(4, 'bonus_cube');
	boxes.setAll('body.collideWorldBounds', true);
	boxes.setAll('outOfBoundsKill', true);
	boxes.setAll('body.bounce.x', 1);
	boxes.setAll('body.bounce.y', 1);
}

function setupExplosions() {
	explosionPool = game.add.group();
	explosionPool.enableBody = true;
	explosionPool.physicsBodyType = Phaser.Physics.ARCADE;
	explosionPool.createMultiple(100, 'explosion');
	explosionPool.setAll('anchor.x', 0.5);
	explosionPool.setAll('anchor.y', 0.5);
	explosionPool.setAll('scale.x', 1.5);
	explosionPool.setAll('scale.y', 1.5);
	explosionPool.forEach(function (explosion) {
		explosion.animations.add('boom');
	});
}

function setupMenu(){
	gamestartMenu = game.add.sprite(game.width/2, game.height / 2, 'gamestartMenu');
	gamestartMenu.anchor.setTo(0.5, 0.5);
}

function resetMenu(){
	gamestartMenu.reset(game.width/2, game.height / 2);
}

function setupULT(){
	ultsign_g = game.add.sprite(16, 36, 'ultsign_g');
}

function setupRocket()	{
	rocketPool = game.add.group();
	rocketPool.enableBody = true;
	rocketPool.physicsBodyType = Phaser.Physics.ARCADE;

	rocketPool.createMultiple(40, 'rocket');
	rocketPool.setAll('checkWorldBounds', true);
	rocketPool.setAll('outOfBoundsKill', true);
	rocketPool.setAll('anchor.x', 0.5);
	rocketPool.setAll('anchor.y', 0.5);
	rocketPool.setAll('scale.x', 0.75);
	rocketPool.setAll('scale.y', 0.75);

	 rocketPool.forEach(function(rocket)	{
	 	//rocket.animations.add('rotate', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], 15);
		// select the up arrow
	 	rocket.frame = 42;
	 });
}

/*
 *	show debug message
 */
function render() {

    game.debug.spriteInfo(player, 32, 32);
    // game.debug.text('angularVelocity: ' + sprite.body.angularVelocity, 32, 200);
    // game.debug.text('angularAcceleration: ' + sprite.body.angularAcceleration, 32, 232);
    // game.debug.text('angularDrag: ' + sprite.body.angularDrag, 32, 264);
    // game.debug.text('deltaZ: ' + sprite.body.deltaZ(), 32, 296);

}

</script>

</body>
</html>
